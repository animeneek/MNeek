<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieNeek | Search</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#222',
            primary: '#ff4444',
          },
        },
      },
    };
  </script>
  <style>
    .glass-nav {
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 1000;
    }
    .movie-card {
      transition: all 0.3s ease;
      transform-origin: center bottom;
    }
    .movie-card:hover {
      transform: scale(1.05);
      z-index: 20;
    }
    .movie-card-container {
      position: relative;
      overflow: visible;
    }
    .movie-poster {
      position: relative;
      overflow: hidden;
    }
    .movie-poster::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30%;
      background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    }
    .rating-circle {
      --percentage: 0;
      --primary: #ff4444;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: 
        radial-gradient(closest-side, #111 85%, transparent 86%),
        conic-gradient(var(--primary) calc(var(--percentage)*1%), #222 0);
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      bottom: 8px;
      left: 8px;
      border: 2px solid #111;
      z-index: 2;
    }
    .rating-circle::before {
      content: attr(data-rating);
      font-size: 9px;
      font-weight: bold;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .no-results {
      background: linear-gradient(to right, rgba(255,68,68,0.1), rgba(255,68,68,0.05));
    }
    .filter-pill {
      transition: all 0.2s ease;
    }
    .filter-pill:hover {
      transform: translateY(-1px);
    }
    .filter-dropdown {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .filter-dropdown.open {
      max-height: 300px;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .filter-btn {
      background: rgba(30, 30, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .filter-btn:hover {
      background: rgba(50, 50, 50, 0.9);
    }
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255,68,68,0.5);
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(255,68,68,0.8);
    }
    /* Dropdown options */
    .dropdown-option {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .dropdown-option:hover {
      background: rgba(255,68,68,0.1);
    }
    .dropdown-option.selected {
      background: rgba(255,68,68,0.2);
      color: #ff4444;
    }
    @media (max-width: 640px) {
      .filter-controls {
        justify-content: center;
        gap: 0.5rem;
      }
      .filter-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }
      .filter-btn i {
        margin-right: 0.2rem;
      }
      .filter-dropdown {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        width: 90vw;
        max-width: 300px;
      }
    }
  </style>
  <style>
  /* Add this at the end of your existing styles */
  @media (max-width: 640px) {
    .filter-btn span:not(.sr-only) {
      display: none;
    }
    .filter-btn i.fa-chevron-down {
      display: none;
    }
    .filter-btn {
      padding: 0.5rem;
      min-width: 36px;
      justify-content: center;
    }
    .filter-btn i:first-child {
      margin-right: 0;
    }
  }
  
  /* Accessibility - hide visually but keep for screen readers */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
</head>
<body class="bg-black text-white">

  <!-- Header -->  
  <div id="header"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 pt-2 pb-24 min-h-screen">
    <!-- Search Filters -->
    <div class="sticky top-20 md:top-16 z-30 bg-black/80 backdrop-blur-sm py-4">
      <!-- Active Filters -->
      <div id="active-filters" class="flex flex-wrap gap-2 mb-3 px-2 justify-center"></div>
      
      <!-- Filter Controls -->
      <div class="filter-controls flex flex-wrap gap-2 px-2 justify-center">
        <!-- Content Type Filter -->
        <div class="relative group">
          <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm">
            <i class="fas fa-list text-primary mr-1"></i>
            <span id="content-type-label">All</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>
          <div class="filter-dropdown absolute left-1/2 transform -translate-x-1/2 mt-1 w-48 bg-dark rounded-lg shadow-lg z-40 border border-gray-800">
            <div class="p-3 max-h-60 overflow-y-auto custom-scrollbar">
              <div class="dropdown-option selected" data-type="multi">All</div>
              <div class="dropdown-option" data-type="movie">Movies</div>
              <div class="dropdown-option" data-type="tv">Series</div>
            </div>
          </div>
        </div>
        
        <!-- Genre Filter -->
        <div class="relative group">
          <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm">
            <i class="fas fa-tags text-primary mr-1"></i>
            <span>Genre</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>
          <div class="filter-dropdown absolute left-1/2 transform -translate-x-1/2 mt-1 w-64 bg-dark rounded-lg shadow-lg z-40 border border-gray-800">
            <div class="p-3 max-h-60 overflow-y-auto custom-scrollbar" id="genre-filter-options"></div>
          </div>
        </div>
        
        <!-- Year Filter -->
        <div class="relative group">
          <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm">
            <i class="fas fa-calendar text-primary mr-1"></i>
            <span>Year</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>
          <div class="filter-dropdown absolute left-1/2 transform -translate-x-1/2 mt-1 w-48 bg-dark rounded-lg shadow-lg z-40 border border-gray-800">
            <div class="p-3">
              <input type="text" id="year-search" placeholder="Search years..." class="w-full bg-gray-900 text-white px-2 py-1 rounded text-sm mb-2">
              <div class="max-h-52 overflow-y-auto custom-scrollbar" id="year-options"></div>
            </div>
          </div>
        </div>
        
        <!-- Language Filter -->
        <div class="relative group">
          <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm">
            <i class="fas fa-language text-primary mr-1"></i>
            <span>Language</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>
          <div class="filter-dropdown absolute left-1/2 transform -translate-x-1/2 mt-1 w-48 bg-dark rounded-lg shadow-lg z-40 border border-gray-800">
            <div class="p-3 max-h-60 overflow-y-auto">
              <input type="text" id="language-search" placeholder="Search..." class="w-full bg-gray-900 text-white px-2 py-1 rounded text-sm mb-2">
              <div id="language-filter-options" class="custom-scrollbar"></div>
            </div>
          </div>
        </div>
        
        <!-- Sort Options -->
        <div class="relative group">
          <button class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm">
            <i class="fas fa-sort text-primary mr-1"></i>
            <span>Sort</span>
            <i class="fas fa-chevron-down text-xs ml-1"></i>
          </button>
          <div class="filter-dropdown absolute left-1/2 transform -translate-x-1/2 mt-1 w-48 bg-dark rounded-lg shadow-lg z-40 border border-gray-800">
            <div class="p-3 max-h-60 overflow-y-auto custom-scrollbar">
              <div class="dropdown-option selected" data-sort="popularity.desc">Popularity Desc</div>
              <div class="dropdown-option" data-sort="popularity.asc">Popularity Asc</div>
              <div class="dropdown-option" data-sort="vote_average.desc">Rating Desc</div>
              <div class="dropdown-option" data-sort="vote_average.asc">Rating Asc</div>
              <div class="dropdown-option" data-sort="primary_release_date.desc">Newest First</div>
              <div class="dropdown-option" data-sort="primary_release_date.asc">Oldest First</div>
            </div>
          </div>
        </div>
        
        <!-- Clear Filters -->
        <button id="clear-filters" class="filter-btn flex items-center px-3 py-1.5 rounded-full text-xs md:text-sm text-gray-400 hover:text-white">
          <i class="fas fa-times text-primary mr-1"></i>
          <span>Clear</span>
        </button>
      </div>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
      <!-- Results will be inserted here -->
      <div class="col-span-full text-center py-20 text-gray-400">
        <i class="fas fa-search fa-2x mb-4"></i>
        <p>Use filters to find movies, series, and people</p>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden text-center py-10">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
    </div>
    
    <!-- Load More Button -->
    <div id="load-more-container" class="text-center mt-6 hidden">
      <button id="load-more" class="px-6 py-2 bg-primary hover:bg-red-600 rounded-full font-medium">
        Load More
      </button>
    </div>
  </main>

<script>
    const TMDB_API_KEY = 'e3afd4c89e3351edad9e875ff7a01f0c';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMAGE_URL = 'https://image.tmdb.org/t/p/w500';
    const DEFAULT_POSTER = 'https://github.com/animeneek/MN/raw/main/assets/Black%20and%20White%20Modern%20Coming%20soon%20Poster.png';
    
    // State management
    const state = {
      currentPage: 1,
      totalPages: 1,
      currentQuery: '',
      filters: {
        contentType: 'multi',
        genres: [],
        years: [],
        language: null,
        sortBy: 'popularity.desc'
      },
      genres: {
        movie: [],
        tv: []
      },
      languages: [],
      allYears: Array.from({length: 30}, (_, i) => new Date().getFullYear() - i) // Last 30 years
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
      // Get query from URL
      const urlParams = new URLSearchParams(window.location.search);
      state.currentQuery = urlParams.get('query') || '';
      
      // Load genres and languages
      await loadGenres();
      await loadLanguages();
      renderYearOptions();
      renderLanguageOptions();
      
      // Setup event listeners
      setupFilterControls();
      setupDropdowns();
      
      // Perform initial search with default filters
      performSearch();
    });

    // Load movie and TV genres
    async function loadGenres() {
      try {
        const [movieGenres, tvGenres] = await Promise.all([
          fetchTMDB('/genre/movie/list'),
          fetchTMDB('/genre/tv/list')
        ]);
        
        state.genres.movie = movieGenres.genres || [];
        state.genres.tv = tvGenres.genres || [];
        
        // Render genre options
        renderGenreOptions();
      } catch (error) {
        console.error('Error loading genres:', error);
      }
    }

    // Load available languages
    async function loadLanguages() {
      try {
        const languages = await fetchTMDB('/configuration/languages');
        
        // Sort languages with priority order
        const priorityLanguages = ['en', 'hi', 'te', 'ta', 'kn', 'ml'];
        const indianLanguages = ['bn', 'pa', 'gu', 'mr', 'or', 'as'];
        
        state.languages = [
          // Priority languages first
          ...priorityLanguages.map(code => 
            languages.find(lang => lang.iso_639_1 === code)
          ).filter(Boolean),
          
          // Other Indian languages
          ...indianLanguages.map(code => 
            languages.find(lang => lang.iso_639_1 === code)
          ).filter(Boolean),
          
          // All other languages
          ...languages.filter(lang => 
            !priorityLanguages.includes(lang.iso_639_1) && 
            !indianLanguages.includes(lang.iso_639_1)
          )
        ].filter(Boolean).slice(0, 100); // Limit to top 100
      } catch (error) {
        console.error('Error loading languages:', error);
      }
    }

    // Render genre filter options
    function renderGenreOptions() {
      const container = document.getElementById('genre-filter-options');
      const currentMediaType = state.filters.contentType === 'tv' ? 'tv' : 'movie';
      const genres = state.genres[currentMediaType] || [];
      
      container.innerHTML = genres.map(genre => `
        <div class="dropdown-option ${state.filters.genres.includes(genre.id) ? 'selected' : ''}" 
             data-id="${genre.id}">
          ${genre.name}
        </div>
      `).join('');
      
      // Add click handlers
      container.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
          const genreId = parseInt(this.getAttribute('data-id'));
          if (state.filters.genres.includes(genreId)) {
            state.filters.genres = state.filters.genres.filter(id => id !== genreId);
          } else {
            state.filters.genres.push(genreId);
          }
          updateActiveFilters();
          performSearch(true); // Reset to page 1
          renderGenreOptions();
        });
      });
    }

    // Render year options
    function renderYearOptions() {
      const container = document.getElementById('year-options');
      const searchInput = document.getElementById('year-search');
      
      const updateYears = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = searchTerm 
          ? state.allYears.filter(year => year.toString().includes(searchTerm))
          : state.allYears;
        
        container.innerHTML = filtered.map(year => `
          <div class="dropdown-option ${state.filters.years.includes(year) ? 'selected' : ''}" 
               data-year="${year}">
            ${year}
          </div>
        `).join('');
        
        // Add click handlers
        container.querySelectorAll('.dropdown-option').forEach(option => {
          option.addEventListener('click', function() {
            const year = parseInt(this.getAttribute('data-year'));
            if (state.filters.years.includes(year)) {
              state.filters.years = state.filters.years.filter(y => y !== year);
            } else {
              state.filters.years.push(year);
            }
            updateActiveFilters();
            performSearch(true); // Reset to page 1
            renderYearOptions();
          });
        });
      };
      
      // Initial render
      updateYears();
      
      // Add search functionality
      searchInput.addEventListener('input', updateYears);
    }

    // Render language filter options
    function renderLanguageOptions() {
      const container = document.getElementById('language-filter-options');
      const searchInput = document.getElementById('language-search');
      
      const filterLanguages = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = searchTerm 
          ? state.languages.filter(lang => 
              lang.english_name.toLowerCase().includes(searchTerm) ||
              lang.iso_639_1.toLowerCase().includes(searchTerm))
          : state.languages;
        
        container.innerHTML = filtered.map(lang => `
          <div class="dropdown-option ${state.filters.language === lang.iso_639_1 ? 'selected' : ''}"
               data-code="${lang.iso_639_1}">
            ${lang.english_name} (${lang.iso_639_1})
          </div>
        `).join('');
        
        // Add click handlers
        container.querySelectorAll('.dropdown-option').forEach(div => {
          div.addEventListener('click', function() {
            const langCode = this.getAttribute('data-code');
            state.filters.language = state.filters.language === langCode ? null : langCode;
            updateActiveFilters();
            performSearch(true); // Reset to page 1
            renderLanguageOptions();
          });
        });
      };
      
      // Initial render
      filterLanguages();
      
      // Add search functionality
      searchInput.addEventListener('input', filterLanguages);
    }

    // Setup filter controls
    function setupFilterControls() {
      // Content type filter
      document.querySelectorAll('[data-type]').forEach(option => {
        option.addEventListener('click', function() {
          const contentType = this.getAttribute('data-type');
          state.filters.contentType = contentType;
          document.getElementById('content-type-label').textContent = this.textContent;
          
          // Update selected state
          document.querySelectorAll('[data-type]').forEach(opt => {
            opt.classList.toggle('selected', opt === this);
          });
          
          updateActiveFilters();
          performSearch(true); // Reset to page 1
          
          // Close dropdown
          this.closest('.filter-dropdown').classList.remove('open');
        });
      });
      
      // Sort filter
      document.querySelectorAll('[data-sort]').forEach(option => {
        option.addEventListener('click', function() {
          state.filters.sortBy = this.getAttribute('data-sort');
          
          // Update selected state
          document.querySelectorAll('[data-sort]').forEach(opt => {
            opt.classList.toggle('selected', opt === this);
          });
          
          updateActiveFilters();
          performSearch(true); // Reset to page 1
          
          // Close dropdown
          this.closest('.filter-dropdown').classList.remove('open');
        });
      });
      
      // Clear filters
      document.getElementById('clear-filters').addEventListener('click', () => {
        state.filters = {
          contentType: 'multi',
          genres: [],
          years: [],
          language: null,
          sortBy: 'popularity.desc'
        };
        
        // Reset UI
        document.getElementById('content-type-label').textContent = 'All';
        document.querySelectorAll('[data-type]').forEach(opt => {
          opt.classList.toggle('selected', opt.textContent === 'All');
        });
        document.querySelectorAll('[data-sort]').forEach(opt => {
          opt.classList.toggle('selected', opt.getAttribute('data-sort') === 'popularity.desc');
        });
        
        updateActiveFilters();
        performSearch(true); // Reset to page 1
        
        // Re-render options
        renderGenreOptions();
        renderLanguageOptions();
        renderYearOptions();
      });
      
      // Load more button
      document.getElementById('load-more').addEventListener('click', () => {
        if (state.currentPage < state.totalPages) {
          state.currentPage++;
          performSearch(false); // Don't reset, append results
        }
      });
    }

    // Setup dropdown toggles
    function setupDropdowns() {
      document.querySelectorAll('.group > button').forEach(button => {
        button.addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = this.nextElementSibling;
          const isOpen = dropdown.classList.contains('open');
          
          // Close all other dropdowns first
          document.querySelectorAll('.filter-dropdown').forEach(d => {
            if (d !== dropdown) d.classList.remove('open');
          });
          
          // Toggle this dropdown
          if (isOpen) {
            dropdown.classList.remove('open');
          } else {
            dropdown.classList.add('open');
          }
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        document.querySelectorAll('.filter-dropdown').forEach(d => {
          d.classList.remove('open');
        });
      });
      
      // Prevent closing when clicking inside dropdown
      document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
        dropdown.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
    }

    // Update active filters display
    function updateActiveFilters() {
      const container = document.getElementById('active-filters');
      const filters = [];
      
      // Content type filter
      if (state.filters.contentType !== 'multi') {
        filters.push({
          type: 'contentType',
          id: state.filters.contentType,
          name: state.filters.contentType === 'movie' ? 'Movies' : 'Series',
          icon: state.filters.contentType === 'movie' ? 'fas fa-film' : 'fas fa-tv'
        });
      }
      
      // Genre filters
      state.filters.genres.forEach(genreId => {
        const currentMediaType = state.filters.contentType === 'tv' ? 'tv' : 'movie';
        const genre = state.genres[currentMediaType].find(g => g.id === genreId);
        if (genre) {
          filters.push({
            type: 'genre',
            id: genreId,
            name: genre.name,
            icon: 'fas fa-tag'
          });
        }
      });
      
      // Year filters
      state.filters.years.forEach(year => {
        filters.push({
          type: 'year',
          id: year,
          name: year,
          icon: 'fas fa-calendar'
        });
      });
      
      // Language filter
      if (state.filters.language) {
        const lang = state.languages.find(l => l.iso_639_1 === state.filters.language);
        if (lang) {
          filters.push({
            type: 'language',
            id: state.filters.language,
            name: lang.english_name,
            icon: 'fas fa-language'
          });
        }
      }
      
      // Sort filter (only show if not default)
      if (state.filters.sortBy !== 'popularity.desc') {
        const sortText = {
          'popularity.asc': 'Popularity (Asc)',
          'vote_average.desc': 'Rating (Desc)',
          'vote_average.asc': 'Rating (Asc)',
          'primary_release_date.desc': 'Newest First',
          'primary_release_date.asc': 'Oldest First'
        }[state.filters.sortBy] || 'Sorted';
        
        filters.push({
          type: 'sort',
          id: 'sort',
          name: sortText,
          icon: 'fas fa-sort'
        });
      }
      
      // Render active filters
      container.innerHTML = filters.map(filter => `
        <div class="filter-pill flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded-full text-xs">
          <i class="${filter.icon} text-primary"></i>
          ${filter.name}
          <button class="remove-filter" data-type="${filter.type}" data-id="${filter.id}">
            <i class="fas fa-times text-gray-400 hover:text-white"></i>
          </button>
        </div>
      `).join('');
      
      // Add remove filter handlers
      document.querySelectorAll('.remove-filter').forEach(button => {
        button.addEventListener('click', function(e) {
          e.stopPropagation();
          const type = this.getAttribute('data-type');
          const id = this.getAttribute('data-id');
          
          switch (type) {
            case 'contentType':
              state.filters.contentType = 'multi';
              document.getElementById('content-type-label').textContent = 'All';
              document.querySelectorAll('[data-type]').forEach(opt => {
                opt.classList.toggle('selected', opt.textContent === 'All');
              });
              break;
            case 'genre':
              state.filters.genres = state.filters.genres.filter(g => g !== parseInt(id));
              renderGenreOptions();
              break;
            case 'year':
              state.filters.years = state.filters.years.filter(y => y !== parseInt(id));
              renderYearOptions();
              break;
            case 'language':
              state.filters.language = null;
              renderLanguageOptions();
              break;
            case 'sort':
              state.filters.sortBy = 'popularity.desc';
              document.querySelectorAll('[data-sort]').forEach(opt => {
                opt.classList.toggle('selected', opt.getAttribute('data-sort') === 'popularity.desc');
              });
              break;
          }
          
          updateActiveFilters();
          performSearch(true); // Reset to page 1
        });
      });
    }

    // Perform search with current filters
    async function performSearch(reset = true) {
      if (reset) {
        state.currentPage = 1;
        document.getElementById('search-results').innerHTML = '';
      }
      
      const resultsContainer = document.getElementById('search-results');
      const loading = document.getElementById('loading');
      const loadMoreBtn = document.getElementById('load-more-container');
      
      // Show loading
      loading.classList.remove('hidden');
      loadMoreBtn.classList.add('hidden');
      
      try {
        let results = [];
        let totalPages = 1;
        
        if (state.filters.contentType === 'multi') {
          // Search both movies and TV shows with proper sorting
          const [movieResponse, tvResponse] = await Promise.all([
            fetch(`${BASE_URL}/search/movie?query=${encodeURIComponent(state.currentQuery)}&page=${state.currentPage}&api_key=${TMDB_API_KEY}&sort_by=${state.filters.sortBy}`).then(res => res.json()),
            fetch(`${BASE_URL}/search/tv?query=${encodeURIComponent(state.currentQuery)}&page=${state.currentPage}&api_key=${TMDB_API_KEY}&sort_by=${state.filters.sortBy}`).then(res => res.json())
          ]);
          
          // Combine results
          results = [...(movieResponse.results || []), ...(tvResponse.results || [])];
          
          // Apply client-side sorting for combined results
          results.sort((a, b) => {
            if (state.filters.sortBy.includes('popularity')) {
              return state.filters.sortBy.includes('desc') ? b.popularity - a.popularity : a.popularity - b.popularity;
            } else if (state.filters.sortBy.includes('vote_average')) {
              return state.filters.sortBy.includes('desc') ? b.vote_average - a.vote_average : a.vote_average - b.vote_average;
            } else if (state.filters.sortBy.includes('release_date')) {
              const dateA = a.release_date || a.first_air_date || '';
              const dateB = b.release_date || b.first_air_date || '';
              return state.filters.sortBy.includes('desc') ? dateB.localeCompare(dateA) : dateA.localeCompare(dateB);
            }
            return 0;
          });
          
          totalPages = Math.max(movieResponse.total_pages || 1, tvResponse.total_pages || 1);
        } else {
          // Search specific content type
          const response = await fetch(
            `${BASE_URL}/search/${state.filters.contentType}?query=${encodeURIComponent(state.currentQuery)}&page=${state.currentPage}&api_key=${TMDB_API_KEY}&sort_by=${state.filters.sortBy}`
          ).then(res => res.json());
          
          results = response.results || [];
          totalPages = response.total_pages || 1;
        }
        
        state.totalPages = totalPages;
        
        // Apply additional filters
        if (state.filters.genres.length > 0) {
          results = results.filter(item => 
            item.genre_ids && state.filters.genres.every(genreId => 
              item.genre_ids.includes(genreId)
            )
          );
        }
        
        if (state.filters.years.length > 0) {
          results = results.filter(item => {
            const releaseYear = item.release_date 
              ? new Date(item.release_date).getFullYear()
              : item.first_air_date 
                ? new Date(item.first_air_date).getFullYear()
                : null;
            return releaseYear && state.filters.years.includes(releaseYear);
          });
        }
        
        if (state.filters.language) {
          results = results.filter(item => 
            item.original_language === state.filters.language
          );
        }
        
        if (results.length === 0 && reset) {
          showNoResults();
          return;
        }
        
        // Append or replace results
        if (reset) {
          resultsContainer.innerHTML = '';
        }
        
        // Create cards for each result
        results.forEach(item => {
          const card = createResultCard(item);
          if (card) {
            resultsContainer.appendChild(card);
          }
        });
        
        // Show load more button if there are more results
        if (state.currentPage < state.totalPages) {
          loadMoreBtn.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Search error:', error);
        if (reset) {
          resultsContainer.innerHTML = `
            <div class="col-span-full text-center py-20 text-gray-400">
              <i class="fas fa-exclamation-circle fa-2x mb-4"></i>
              <p>Error loading results. Please try again.</p>
            </div>
          `;
        }
      } finally {
        loading.classList.add('hidden');
      }
    }

    // Create result card based on item type
    function createResultCard(item) {
      const div = document.createElement('div');
      div.className = 'movie-card-container fade-in';
      
      if (item.media_type === 'movie' || (state.filters.contentType === 'movie' && !item.media_type)) {
        const percentage = Math.round(item.vote_average * 10);
        
        div.innerHTML = `
          <div class="movie-card w-40 sm:w-48 md:w-56">
            <a href="info.html?id=${item.id}&type=movie" class="block relative">
              <div class="movie-poster aspect-[2/3] bg-dark rounded-lg overflow-hidden mb-2">
                <img 
                  src="${item.poster_path ? IMAGE_URL + item.poster_path : DEFAULT_POSTER}" 
                  alt="${item.title}"
                  class="w-full h-full object-cover"
                  loading="lazy"
                >
                ${item.vote_average > 0 ? `
                  <div class="rating-circle" data-rating="${percentage}%" style="--percentage: ${percentage}"></div>
                ` : ''}
              </div>
              <h3 class="font-medium truncate">${item.title}</h3>
              <p class="text-xs text-gray-400">${item.release_date?.substring(0,4) || 'N/A'}</p>
            </a>
          </div>
        `;
      } 
      else if (item.media_type === 'tv' || (state.filters.contentType === 'tv' && !item.media_type)) {
        const percentage = Math.round(item.vote_average * 10);
        
        div.innerHTML = `
          <div class="movie-card w-40 sm:w-48 md:w-56">
            <a href="info.html?id=${item.id}&type=tv" class="block relative">
              <div class="movie-poster aspect-[2/3] bg-dark rounded-lg overflow-hidden mb-2">
                <img 
                  src="${item.poster_path ? IMAGE_URL + item.poster_path : DEFAULT_POSTER}" 
                  alt="${item.name}"
                  class="w-full h-full object-cover"
                  loading="lazy"
                >
                ${item.vote_average > 0 ? `
                  <div class="rating-circle" data-rating="${percentage}%" style="--percentage: ${percentage}"></div>
                ` : ''}
              </div>
              <h3 class="font-medium truncate">${item.name}</h3>
              <p class="text-xs text-gray-400">${item.first_air_date?.substring(0,4) || 'N/A'}</p>
            </a>
          </div>
        `;
      }
      else {
        return null; // Unknown type
      }
      
      return div;
    }

    // Show no results state
    function showNoResults() {
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = `
        <div class="col-span-full no-results rounded-lg p-8 text-center">
          <i class="fas fa-film fa-3x mb-4 text-primary/50"></i>
          <h3 class="text-xl font-bold mb-2">No results found</h3>
          <p class="text-gray-400">Try adjusting your filters</p>
        </div>
      `;
    }

    // TMDB API Helper
    async function fetchTMDB(endpoint) {
      try {
        const res = await fetch(`${BASE_URL}${endpoint}?api_key=${TMDB_API_KEY}`);
        return await res.json();
      } catch (err) {
        console.error(`Error fetching ${endpoint}:`, err);
        return {};
      }
    }

    // Fetch the header.html content and insert it into the #header div
    fetch('header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header').innerHTML = data;
        
        // Handle search form submission from header
        document.querySelectorAll('form[action="search.html"]').forEach(form => {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = this.querySelector('input').value.trim();
            if (query) {
              window.location.href = `search.html?query=${encodeURIComponent(query)}`;
            }
          });
        });
      })
      .catch(error => console.error('Error fetching header:', error));
  </script>
  
</body>
</html>
